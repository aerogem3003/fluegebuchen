<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerogem Airline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-50 text-gray-800;
        }
        .header {
            background-image: url('https://placehold.co/1920x400/292b3a/a0aec0?text=AEROGEM');
            background-size: cover;
            background-position: center;
            @apply text-white text-center py-20 px-4;
        }
        .container {
            @apply max-w-4xl mx-auto p-4;
        }
        .btn-primary {
            @apply px-6 py-3 bg-blue-600 text-white font-medium rounded-xl hover:bg-blue-700 transition duration-300;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-xl hover:bg-gray-300 transition duration-300;
        }
    </style>
</head>
<body>

    <div class="header rounded-b-3xl shadow-lg">
        <h1 class="text-5xl font-extrabold mb-4">AEROGEM</h1>
        <p class="text-xl font-light mb-6">Ihr Weg in die Lüfte.</p>
        <p class="text-xs text-gray-300">Demo-Website. Es werden keine echten Flüge verkauft.</p>
    </div>

    <div class="container my-12">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-blue-900 mb-2">Die Welt wartet auf Sie!</h2>
            <p class="text-sm text-gray-600 mb-6">Breite Auswahl | Uns vertrauen 40 Millionen Passagiere jährlich | Mehr als 20 Jahre Erfahrung</p>
            <p class="text-lg text-gray-700 max-w-2xl mx-auto">
                Buchen Sie jetzt Ihren nächsten Flug mit AEROGEM und entdecken Sie die besten Destinationen weltweit.
                Unsere intuitive Suchmaschine findet schnell die besten Verbindungen für Sie, von Direktflügen
                bis hin zu Flügen mit Umsteigeverbindungen.
            </p>
        </div>

        <!-- Search Form -->
        <div class="bg-white p-8 rounded-2xl shadow-xl">
            <h3 class="text-2xl font-semibold text-blue-800 mb-6">Flug finden</h3>
            <form id="search-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="abflugort" class="block text-sm font-medium text-gray-700">Abflug</label>
                        <input type="text" id="abflugort" placeholder="Flughafen (z.B. FRA) oder Stadt" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="ankunftsort" class="block text-sm font-medium text-gray-700">Ankunft</label>
                        <input type="text" id="ankunftsort" placeholder="Flughafen (z.B. BER) oder Stadt" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="monat" class="block text-sm font-medium text-gray-700">Monat der Abreise</label>
                    <input type="month" id="monat" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                </div>
                <button type="submit" class="btn-primary w-full">Flüge suchen</button>
            </form>
        </div>
        
        <!-- Search Results -->
        <div class="mt-12">
            <h3 class="text-2xl font-semibold text-blue-800 mb-6">Suchergebnisse</h3>
            <div id="search-results-list" class="space-y-4">
                <p class="text-center text-gray-500">Geben Sie Ihre Reisedaten ein, um Flüge zu finden.</p>
            </div>
        </div>

        <!-- Featured Flights (automatically displayed) -->
        <div class="mt-12">
            <h3 class="text-2xl font-semibold text-blue-800 mb-6">Beliebte Flüge</h3>
            <div id="featured-flights-list" class="space-y-4">
                <p class="text-center text-gray-500">Lade beliebte Flüge...</p>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="booking-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-blue-800">Flug buchen</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <form id="booking-form" class="space-y-4">
                    <div id="itinerary-display" class="mb-4"></div>
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Name und Vorname</label>
                        <input type="text" id="name" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="telefon" class="block text-sm font-medium text-gray-700">Telefonnummer</label>
                        <input type="tel" id="telefon" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700">Geburtsdatum</label>
                        <input type="date" id="dob" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm">
                    </div>
                    <div class="mt-4">
                        <p class="text-lg font-bold text-blue-900">Gesamtpreis: <span id="total-price">0 €</span></p>
                    </div>
                    <button type="submit" class="btn-primary w-full mt-4">Kostenpflichtig buchen</button>
                </form>
            </div>
        </div>

        <!-- Booking Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-blue-800">Buchungsbestätigung</h3>
                    <button id="close-confirmation-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <div id="confirmation-details" class="space-y-4"></div>
                <div class="mt-6 text-sm text-gray-600">
                    <p>
                        Wenn Sie eine Änderung an Ihrer Buchung vornehmen möchten, kontaktieren Sie uns bitte per E-Mail unter <a href="mailto:support@aerogem.com" class="text-blue-600 hover:underline">support@aerogem.com</a>.
                    </p>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white text-center rounded-xl shadow-lg transition-all duration-300 hidden" style="max-width: 300px;">
            <p id="messageText"></p>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, child, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAjC4kzGs2G2gT9kiNSa5YzBRNy3IiqkTo",
            authDomain: "luciennervt.firebaseapp.com",
            databaseURL: "https://luciennervt-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "luciennervt",
            storageBucket: "luciennervt.firebasestorage.app",
            messagingSenderId: "483314146697",
            appId: "1:483314146697:web:46b08edad2180cbce05558"
        };
        
        // IMPORTANT: Use the global variables provided by the Canvas environment for paths and auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const sanitizedAppId = appId.replace(/\./g, '-');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const airportCodes = {
            'DUS': 'Düsseldorf', 'FRA': 'Frankfurt', 'BER': 'Berlin', 'MUC': 'München',
            'AMS': 'Amsterdam', 'LAX': 'Los Angeles', 'JFK': 'New York', 'CDG': 'Paris',
            'LHR': 'London', 'ZRH': 'Zürich', 'VIE': 'Wien', 'MAD': 'Madrid',
            'FCO': 'Rom', 'DXB': 'Dubai', 'SYD': 'Sydney', 'NRT': 'Tokio',
            'SFO': 'San Francisco', 'BCN': 'Barcelona', 'IST': 'Istanbul', 'BKK': 'Bangkok',
        };

        let userId = null;
        let flightsRef = null;
        let bookingsRef = null;
        let authReady = false;
        let allFlights = [];

        // Message box functions
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // Authenticate user and get references
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                flightsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/flights`);
                bookingsRef = ref(db, `artifacts/${sanitizedAppId}/users/${userId}/bookings`);
                authReady = true;
                
                listenForFlights();

            } else {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Authentifizierungsfehler:", e);
                    showMessage("Fehler bei der Authentifizierung.");
                }
            }
        });

        // Listen for flights and store them
        function listenForFlights() {
            onValue(flightsRef, (snapshot) => {
                const flightsData = snapshot.val();
                allFlights = flightsData ? Object.keys(flightsData).map(key => ({ id: key, ...flightsData[key] })) : [];
                renderFeaturedFlights();
            });
        }
        
        // Render featured flights (upcoming flights in the current month)
        function renderFeaturedFlights() {
             const featuredFlightsList = document.getElementById('featured-flights-list');
             featuredFlightsList.innerHTML = '';
             const now = new Date();
             const currentMonth = now.getMonth();
             const currentYear = now.getFullYear();
             
             const upcomingFlights = allFlights.filter(flight => {
                 const flightDate = new Date(flight.datum);
                 return flightDate.getMonth() === currentMonth && flightDate.getFullYear() === currentYear;
             }).sort((a, b) => new Date(a.datum + 'T' + a.zeit) - new Date(b.datum + 'T' + b.zeit));

             if (upcomingFlights.length > 0) {
                 upcomingFlights.forEach(flight => {
                     const flightItem = createFlightItem(flight);
                     featuredFlightsList.appendChild(flightItem);
                 });
             } else {
                 featuredFlightsList.innerHTML = '<p class="text-center text-gray-500">Keine aktuellen Flüge für diesen Monat gefunden.</p>';
             }
        }
        
        // Helper to convert full name or city name to code
        function nameToCode(name) {
             const cleanedName = name.toLowerCase().replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ä/g, 'a');
             // Check if it's already a code
             if (airportCodes[name.toUpperCase()]) {
                 return name.toUpperCase();
             }
             // Check for city name
             for (const code in airportCodes) {
                 if (airportCodes[code].toLowerCase() === cleanedName) {
                     return code;
                 }
             }
             return name.toUpperCase(); // Fallback
        }

        // Search form submission
        const searchForm = document.getElementById('search-form');
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const abflugort = nameToCode(document.getElementById('abflugort').value);
            const ankunftsort = nameToCode(document.getElementById('ankunftsort').value);
            const monat = document.getElementById('monat').value;
            
            let results = findFlights(abflugort, ankunftsort, monat);
            renderSearchResults(results);
        });
        
        // Find flights (direct and with layover)
        function findFlights(abflug, ankunft, monat) {
            if (!abflug || !ankunft) return [];

            const [year, month] = monat.split('-').map(Number);
            const flightsForMonth = allFlights.filter(f => {
                const flightDate = new Date(f.datum);
                return flightDate.getFullYear() === year && (flightDate.getMonth() + 1) === month;
            });

            const directFlights = flightsForMonth.filter(f => f.abflug.toUpperCase() === abflug && f.ankunft.toUpperCase() === ankunft);
            
            const layoverFlights = [];
            flightsForMonth.forEach(firstLeg => {
                if (firstLeg.abflug.toUpperCase() === abflug) {
                    flightsForMonth.forEach(secondLeg => {
                        // Check if the layover is a day later and a valid connection
                        const firstLegDate = new Date(firstLeg.datum);
                        const secondLegDate = new Date(secondLeg.datum);
                        if (secondLeg.abflug === firstLeg.ankunft && secondLeg.ankunft.toUpperCase() === ankunft && secondLegDate > firstLegDate) {
                            layoverFlights.push([firstLeg, secondLeg]);
                        }
                    });
                }
            });
            
            return { direct: directFlights, layover: layoverFlights };
        }
        
        // Render search results
        function renderSearchResults(results) {
            const resultsList = document.getElementById('search-results-list');
            resultsList.innerHTML = '';
            
            if (results.direct.length === 0 && results.layover.length === 0) {
                 resultsList.innerHTML = '<p class="text-center text-gray-500">Keine Flüge für die ausgewählten Kriterien gefunden.</p>';
                 return;
            }

            // Render direct flights
            if (results.direct.length > 0) {
                resultsList.innerHTML += '<h4 class="text-lg font-semibold text-blue-700 mb-2">Direktflüge</h4>';
                results.direct.forEach(flight => {
                    const flightItem = createFlightItem(flight, true);
                    resultsList.appendChild(flightItem);
                });
            }

            // Render layover flights
            if (results.layover.length > 0) {
                resultsList.innerHTML += '<h4 class="text-lg font-semibold text-blue-700 mt-6 mb-2">Flüge mit Umsteigeverbindung</h4>';
                results.layover.forEach(legs => {
                    const layoverItem = createLayoverItem(legs);
                    resultsList.appendChild(layoverItem);
                });
            }
        }
        
        // Create a single flight item HTML element
        function createFlightItem(flight, isSearchResult = false) {
             const flightItem = document.createElement('div');
             flightItem.className = 'bg-white p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0';
             const departureCity = airportCodes[flight.abflug] || flight.abflug;
             const arrivalCity = airportCodes[flight.ankunft] || flight.ankunft;
             flightItem.innerHTML = `
                 <div class="flex-grow">
                     <p class="text-lg font-bold text-blue-900">${departureCity} (${flight.abflug}) &rarr; ${arrivalCity} (${flight.ankunft})</p>
                     <p class="text-sm text-gray-600">Flugnr: ${flight.flugnr} • Datum: ${flight.datum} • Zeit: ${flight.zeit}</p>
                     <p class="text-sm font-medium text-gray-600">Klasse: ${flight.klasse} • Dauer: ${flight.dauerMin} Min</p>
                 </div>
                 <div class="flex-shrink-0 flex items-center space-x-4 mt-4 md:mt-0">
                     <p class="text-2xl font-bold text-green-600">${flight.preis} €</p>
                     <button data-id="${flight.id}" data-type="direct" class="btn-primary book-btn">Buchen</button>
                 </div>
             `;
             return flightItem;
        }

        // Create a layover flight item HTML element
        function createLayoverItem(legs) {
             const layoverItem = document.createElement('div');
             layoverItem.className = 'bg-white p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0';
             
             const totalPrice = legs.reduce((sum, leg) => sum + leg.preis, 0);
             const departureCity = airportCodes[legs[0].abflug] || legs[0].abflug;
             const arrivalCity = airportCodes[legs[legs.length - 1].ankunft] || legs[legs.length - 1].ankunft;
             
             let detailsHtml = '';
             legs.forEach((leg, index) => {
                 detailsHtml += `
                     <p class="text-sm font-bold text-blue-800">Teilstück ${index + 1}:</p>
                     <p class="text-sm text-gray-600">Flugnr: ${leg.flugnr} • ${airportCodes[leg.abflug] || leg.abflug} (${leg.abflug}) &rarr; ${airportCodes[leg.ankunft] || leg.ankunft} (${leg.ankunft})</p>
                     <p class="text-sm text-gray-600">Datum: ${leg.datum} • Zeit: ${leg.zeit} • Dauer: ${leg.dauerMin} Min</p>
                 `;
             });
             
             layoverItem.innerHTML = `
                 <div class="flex-grow space-y-2">
                     <p class="text-lg font-bold text-blue-900">${departureCity} &rarr; ${arrivalCity} (Umsteigeverbindung)</p>
                     ${detailsHtml}
                 </div>
                 <div class="flex-shrink-0 flex items-center space-x-4 mt-4 md:mt-0">
                     <p class="text-2xl font-bold text-green-600">${totalPrice.toFixed(2)} €</p>
                     <button data-ids='${JSON.stringify(legs.map(l => l.id))}' data-type="layover" class="btn-primary book-btn">Buchen</button>
                 </div>
             `;
             return layoverItem;
        }

        // Handle booking button click
        document.addEventListener('click', async (e) => {
            const element = e.target;
            if (element.classList.contains('book-btn')) {
                if (!authReady) {
                    showMessage("Bitte warten Sie, bis die Seite geladen ist.");
                    return;
                }
                
                let itinerary = [];
                let totalPrice = 0;
                let isLayover = element.getAttribute('data-type') === 'layover';

                if (isLayover) {
                    const ids = JSON.parse(element.getAttribute('data-ids'));
                    itinerary = ids.map(id => allFlights.find(f => f.id === id));
                } else {
                    const flightId = element.getAttribute('data-id');
                    itinerary.push(allFlights.find(f => f.id === flightId));
                }
                
                totalPrice = itinerary.reduce((sum, flight) => sum + flight.preis, 0);

                // Populate modal
                const itineraryDisplay = document.getElementById('itinerary-display');
                itineraryDisplay.innerHTML = '';
                itinerary.forEach((flight, index) => {
                    const flightDiv = document.createElement('div');
                    const departureCity = airportCodes[flight.abflug] || flight.abflug;
                    const arrivalCity = airportCodes[flight.ankunft] || flight.ankunft;
                    flightDiv.innerHTML = `
                        <p class="text-sm font-bold">${isLayover ? `Teilstück ${index + 1}:` : 'Ihr Flug:'}</p>
                        <p class="text-base">${departureCity} (${flight.abflug}) &rarr; ${arrivalCity} (${flight.ankunft})</p>
                        <p class="text-sm text-gray-600">${flight.datum} um ${flight.zeit} • ${flight.preis} €</p>
                    `;
                    itineraryDisplay.appendChild(flightDiv);
                });
                document.getElementById('total-price').textContent = `${totalPrice.toFixed(2)} €`;
                
                // Store itinerary data for form submission
                document.getElementById('booking-form').itinerary = itinerary;
                document.getElementById('booking-form').totalPrice = totalPrice;

                document.getElementById('booking-modal').classList.remove('hidden');
            }
        });

        // Booking form submission
        const bookingForm = document.getElementById('booking-form');
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const bookingData = {
                name: document.getElementById('name').value,
                telefon: document.getElementById('telefon').value,
                email: document.getElementById('email').value,
                dob: document.getElementById('dob').value,
                totalPrice: bookingForm.totalPrice,
                itinerary: bookingForm.itinerary
            };
            
            try {
                await push(bookingsRef, bookingData);
                showMessage("Buchung erfolgreich!");
                bookingForm.reset();
                document.getElementById('booking-modal').classList.add('hidden');
                
                // Show confirmation modal
                const confirmationDetails = document.getElementById('confirmation-details');
                confirmationDetails.innerHTML = `
                    <p class="text-xl font-bold">Vielen Dank für Ihre Buchung, ${bookingData.name}!</p>
                    <p>Ihre Buchung wurde erfolgreich bestätigt.</p>
                    <div class="mt-4">
                        <p class="font-semibold">Buchungsdetails:</p>
                        ${bookingData.itinerary.map((flight, index) => `
                            <p class="text-sm mt-2">
                                Flug ${index + 1}: ${airportCodes[flight.abflug] || flight.abflug} &rarr; ${airportCodes[flight.ankunft] || flight.ankunft}<br>
                                Flugnummer: ${flight.flugnr}<br>
                                Datum: ${flight.datum}, Zeit: ${flight.zeit}
                            </p>
                        `).join('')}
                        <p class="text-lg font-bold mt-4">Gesamtpreis: ${bookingData.totalPrice.toFixed(2)} €</p>
                    </div>
                `;
                document.getElementById('confirmation-modal').classList.remove('hidden');

            } catch (error) {
                console.error("Fehler bei der Buchung:", error);
                showMessage("Fehler bei der Buchung. Versuchen Sie es erneut.");
            }
        });

        // Close modals
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('booking-modal').classList.add('hidden');
        });
        document.getElementById('close-confirmation-modal').addEventListener('click', () => {
            document.getElementById('confirmation-modal').classList.add('hidden');
        });

    </script>
</body>
</html>
