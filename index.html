<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aerogem – Flug buchen (Demo)</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2b;--fg:#e5e7eb;--muted:#9aa3b2;--accent:#60a5fa;--ok:#34d399;--err:#f87171;--border:#22314d}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#09101d,#0b1220);color:var(--fg)}
    .demo-note{background:#f87171;color:#fff;text-align:center;padding:10px;font-weight:700}
    header{padding:18px 16px;text-align:center;border-bottom:1px solid var(--border)}
    header h1{margin:0;font-size:22px}
    .wrap{max-width:960px;margin:20px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .flights{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px}
    @media(min-width:820px){.flights{grid-template-columns:1fr 1fr}}
    .flight{border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;background:#0d1728}
    .flight:hover{border-color:var(--accent)}
    .flight.selected{outline:2px solid var(--accent)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0d1728;color:var(--fg);font-size:15px}
    button{background:var(--accent);border:none;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .meta{font-size:13px;color:var(--muted)}
    .title{font-weight:700;margin-bottom:4px}
    .days{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;display:inline-block;margin-top:8px}
    .msg{margin-top:12px;padding:10px 12px;border-radius:10px;font-size:14px;border:1px solid var(--border)}
    .msg.ok{background:#0d241b;border-color:#1f6b4e;color:#b6f3d4}
    .msg.err{background:#241314;border-color:#6b1f25;color:#f8c7cd}
  </style>
</head>
<body>
  <div class="demo-note">Demo-Website. Es werden keine echten Flüge verkauft.</div>
  <header><h1>Aerogem – Flug buchen</h1></header>

  <div class="wrap">
    <div class="card" id="flightsCard">
      <h2 style="margin:0 0 10px 0;font-size:18px">Verfügbare Flüge</h2>
      <div class="flights" id="flights"></div>
      <div class="meta" id="selectionHint">Bitte einen Flug anklicken.</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="vorname">Vorname</label>
          <input id="vorname" autocomplete="given-name" required />
        </div>
        <div>
          <label for="nachname">Nachname</label>
          <input id="nachname" autocomplete="family-name" required />
        </div>
        <div>
          <label for="geburtsdatum">Geburtsdatum</label>
          <input id="geburtsdatum" type="date" required />
        </div>
        <div>
          <label for="telefon">Telefonnummer</label>
          <input id="telefon" type="tel" placeholder="+49…" required />
        </div>
        <div>
          <label for="email">E-Mail-Adresse</label>
          <input id="email" type="email" autocomplete="email" required />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="bookBtn">Flug buchen</button>
        <div id="msg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpgCuHH2uemLA89qbeS5FkTDH40jfd7rY",
      authDomain: "aerogem-c8afc.firebaseapp.com",
      databaseURL: "https://aerogem-c8afc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aerogem-c8afc",
      storageBucket: "aerogem-c8afc.appspot.com",
      messagingSenderId: "909540667460",
      appId: "1:909540667460:web:5ef56747afcfc92ef7cc11"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const flightsEl = document.getElementById('flights');
    const bookBtn = document.getElementById('bookBtn');
    const msgBox = document.getElementById('msg');
    const selectionHint = document.getElementById('selectionHint');
    let selectedFlightId = null;

    function daysUntil(dateStr){
      if(!dateStr) return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(dateStr); d.setHours(0,0,0,0);
      const diff = Math.round((d - today) / 86400000);
      return diff;
    }
    function daysLabel(d){
      if(d === null) return "";
      if(d === 0) return "Heute";
      if(d > 0) return `in ${d} Tag${d===1?"":"en"}`;
      return `vor ${Math.abs(d)} Tag${d===-1?"":"en"}`;
    }
    function showMsg(text, ok=false){
      msgBox.className = 'msg ' + (ok ? 'ok' : 'err');
      msgBox.textContent = text;
    }

    // Flüge listen
    onValue(ref(db, 'flights'), snap => {
      const val = snap.val() || {};
      const items = Object.entries(val).map(([id,f])=>({id,...f}));
      items.sort((a,b)=>(`${a.date||''} ${a.time||''}`).localeCompare(`${b.date||''} ${b.time||''}`));
      flightsEl.innerHTML = '';
      selectedFlightId = null;
      selectionHint.textContent = items.length ? 'Bitte einen Flug anklicken.' : 'Keine Flüge verfügbar.';

      for(const f of items){
        const d = daysUntil(f.date);
        const card = document.createElement('div');
        card.className = 'flight';
        card.innerHTML = `
          <div class="title">${f.number || "—"} &nbsp; ${f.origin||"?"} → ${f.destination||"?"}</div>
          <div class="meta">${f.date||"?"} &nbsp; ${f.time||""} &middot; ${Number(f.price||0).toFixed(2)} €</div>
          <span class="days">${daysLabel(d)}</span>
        `;
        card.addEventListener('click', ()=>{
          selectedFlightId = f.id;
          document.querySelectorAll('.flight').forEach(x=>x.classList.remove('selected'));
          card.classList.add('selected');
          selectionHint.textContent = `Ausgewählt: ${f.number || f.origin+"→"+f.destination}`;
        });
        flightsEl.appendChild(card);
      }
    });

    // Buchen
    bookBtn.addEventListener('click', async () => {
      msgBox.className = ''; msgBox.textContent = '';
      const vorname = (document.getElementById('vorname').value.trim());
      const nachname = (document.getElementById('nachname').value.trim());
      const geburtsdatum = document.getElementById('geburtsdatum').value;
      const telefon = document.getElementById('telefon').value.trim();
      const email = document.getElementById('email').value.trim();

      if(!selectedFlightId) return showMsg('Bitte zuerst einen Flug anklicken.');
      if(!vorname || !nachname || !geburtsdatum || !telefon || !email) return showMsg('Bitte alle Felder ausfüllen.');
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showMsg('E-Mail ist ungültig.');

      bookBtn.disabled = true;
      try{
        const bookingRef = push(ref(db, 'bookings'));
        await set(bookingRef, {
          flightId: selectedFlightId,
          vorname, nachname, geburtsdatum, telefon, email,
          createdAt: Date.now()
        });
        await set(push(ref(db, `flights/${selectedFlightId}/bookings`)), {bookingId: bookingRef.key, createdAt: Date.now()});
        showMsg(`Buchung gespeichert. Referenz: ${bookingRef.key?.slice(-8)}`, true);

        ['vorname','nachname','geburtsdatum','telefon','email'].forEach(id=>document.getElementById(id).value='');
        selectedFlightId = null;
        document.querySelectorAll('.flight').forEach(x=>x.classList.remove('selected'));
        selectionHint.textContent = 'Bitte einen Flug anklicken.';
      }catch(e){
        console.error(e);
        showMsg('Fehler beim Speichern.');
      }finally{
        bookBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
