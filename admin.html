<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aerogem – Admin (Demo)</title>
<style>
  :root{--bg:#f6f7f9;--card:#ffffff;--fg:#0a0a0a;--muted:#64748b;--accent:#007aff;--border:#e5e7eb;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{padding:18px 16px;text-align:center;background:linear-gradient(#fff,#fafafa);border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:22px;font-weight:700}
  .note{background:#ffe8e8;color:#7a1d1d;text-align:center;padding:10px;font-weight:600;border-bottom:1px solid #ffd4d4}
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.grid.cols-6{grid-template-columns:repeat(6,1fr)}}
  label{font-size:13px;color:var(--muted);display:block;margin:0 0 6px}
  input,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:15px}
  button{background:var(--accent);color:#fff;border:none;font-weight:600;cursor:pointer}
  button.ghost{background:#f3f4f6;color:#111;border:1px solid var(--border)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
  th{color:var(--muted);font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-right:6px;background:#fafafa}
  .clsRow{display:flex;gap:8px;align-items:center;margin-top:8px}
  .danger{background:#ef4444;color:#fff;border:none}
</style>
</head>
<body>
  <div class="note">Demo-Website. Es werden keine echten Flüge verkauft.</div>
  <header><h1>Aerogem – Admin</h1></header>

  <div class="wrap">
    <!-- Flug anlegen/bearbeiten -->
    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Flug</h2>
      <div class="grid cols-6">
        <div><label for="fNumber">Flugnummer</label><input id="fNumber" placeholder="AG123"></div>
        <div><label for="fOrigin">Abflug (IATA)</label><input id="fOrigin" placeholder="DUS"></div>
        <div><label for="fDestination">Ankunft (IATA)</label><input id="fDestination" placeholder="BER"></div>
        <div><label for="fDate">Datum</label><input id="fDate" type="date"></div>
        <div><label for="fTime">Uhrzeit</label><input id="fTime" type="time"></div>
        <div><label for="fDuration">Dauer (Min, optional)</label><input id="fDuration" type="number" min="0"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveBtn">Speichern</button>
        <button id="resetBtn" class="ghost">Felder leeren</button>
        <span id="editBadge" class="pill" style="display:none">Bearbeitung</span>
      </div>
    </div>

    <!-- Klassen-Verwaltung für ausgewählten Flug -->
    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 10px 0;font-size:18px">Klassen des aktuellen Flugs</h2>
      <div class="clsRow">
        <input id="clsName" placeholder="z. B. Economy / Business / First" style="flex:2">
        <input id="clsPrice" type="number" step="0.01" min="0" placeholder="Preis €" style="flex:1">
        <button id="addClassBtn" style="flex:0 0 auto">Klasse hinzufügen</button>
      </div>
      <div id="classesList" style="margin-top:8px"></div>
      <div class="pill" id="noFlightHint" style="display:inline-block;margin-top:8px">Kein Flug ausgewählt</div>
    </div>

    <!-- Übersicht -->
    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 10px 0;font-size:18px">Flüge</h2>
      <table>
        <thead><tr><th>Flug</th><th>Route</th><th>Datum</th><th>Zeit</th><th>Klassen</th><th>Aktionen</th></tr></thead>
        <tbody id="flightRows"></tbody>
      </table>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update, remove, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpgCuHH2uemLA89qbeS5FkTDH40jfd7rY",
  authDomain: "aerogem-c8afc.firebaseapp.com",
  databaseURL: "https://aerogem-c8afc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "aerogem-c8afc",
  storageBucket: "aerogem-c8afc.appspot.com",
  messagingSenderId: "909540667460",
  appId: "1:909540667460:web:5ef56747afcfc92ef7cc11"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// UI
const fNumber = document.getElementById('fNumber');
const fOrigin = document.getElementById('fOrigin');
const fDestination = document.getElementById('fDestination');
const fDate = document.getElementById('fDate');
const fTime = document.getElementById('fTime');
const fDuration = document.getElementById('fDuration');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const editBadge = document.getElementById('editBadge');
const rows = document.getElementById('flightRows');

const clsName = document.getElementById('clsName');
const clsPrice = document.getElementById('clsPrice');
const addClassBtn = document.getElementById('addClassBtn');
const classesList = document.getElementById('classesList');
const noFlightHint = document.getElementById('noFlightHint');

let editingId = null;
let cache = {};

function clearForm(){
  editingId=null; editBadge.style.display='none';
  [fNumber,fOrigin,fDestination,fDate,fTime,fDuration].forEach(i=>i.value='');
  renderClassesUI(null);
}
resetBtn.addEventListener('click', clearForm);

saveBtn.addEventListener('click', async ()=>{
  const flight = {
    number: (fNumber.value||'').trim(),
    origin: (fOrigin.value||'').trim().toUpperCase(),
    destination: (fDestination.value||'').trim().toUpperCase(),
    date: (fDate.value||'').trim(),
    time: (fTime.value||'').trim(),
    durationMin: fDuration.value? Number(fDuration.value): null
  };
  if(!flight.origin || !flight.destination || !flight.date || !flight.time){
    alert('Route, Datum und Zeit sind Pflicht.');
    return;
  }
  try{
    if(editingId){
      await update(ref(db, `flights/${editingId}`), flight);
    }else{
      const newRef = push(ref(db,'flights'));
      await set(newRef, flight);
      editingId = newRef.key; // direkt weiter bearbeiten (z.B. Klassen)
      editBadge.style.display='inline-block';
    }
  }catch(e){ console.error(e); alert('Speichern fehlgeschlagen.'); }
});

function renderClassesUI(f){
  classesList.innerHTML='';
  if(!f){ noFlightHint.style.display='inline-block'; return; }
  noFlightHint.style.display='none';
  const classes = f.classes || {};
  const entries = Object.entries(classes);
  if(entries.length===0){
    classesList.innerHTML = `<div class="muted">Keine Klassen angelegt.</div>`;
    return;
  }
  for(const [key,c] of entries){
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `
      <span class="pill"><strong>${c.name||key}</strong> · ${Number(c.price||0).toFixed(2)} €</span>
      <button class="danger" data-k="${key}">Löschen</button>
    `;
    row.querySelector('button').addEventListener('click', async ()=>{
      if(!confirm('Klasse löschen?')) return;
      try{
        const copy = {...(cache[editingId]||{})};
        copy.classes = {...(copy.classes||{})};
        delete copy.classes[key];
        await update(ref(db,`flights/${editingId}`), {classes: (Object.keys(copy.classes).length? copy.classes : null)});
      }catch(e){ console.error(e); alert('Löschen fehlgeschlagen.'); }
    });
    classesList.appendChild(row);
  }
}

addClassBtn.addEventListener('click', async ()=>{
  if(!editingId){ alert('Zuerst Flug speichern/auswählen.'); return; }
  const name = clsName.value.trim(); const price = parseFloat(clsPrice.value||'0');
  if(!name){ alert('Klassenname fehlt.'); return; }
  const key = name.toLowerCase().replace(/\s+/g,'_').slice(0,24); // id
  try{
    const snap = await get(child(ref(db),`flights/${editingId}/classes/${key}`));
    if(snap.exists()){ alert('Klasse existiert bereits.'); return; }
    await update(ref(db,`flights/${editingId}/classes/${key}`), {name, price});
    clsName.value=''; clsPrice.value='';
  }catch(e){ console.error(e); alert('Hinzufügen fehlgeschlagen.'); }
});

// Tabelle
onValue(ref(db,'flights'), snap=>{
  cache = snap.val()||{};
  const list = Object.entries(cache).map(([id,f])=>({id,...f}));
  list.sort((a,b)=>(`${a.date||''} ${a.time||''}`).localeCompare(`${b.date||''} ${b.time||''}`));
  rows.innerHTML='';
  for(const f of list){
    const tr = document.createElement('tr');
    const cls = f.classes? Object.values(f.classes).map(c=>c.name).join(', ') : '—';
    tr.innerHTML = `
      <td>${f.number||'—'}</td>
      <td>${f.origin||'?'} → ${f.destination||'?'}</td>
      <td>${f.date||'—'}</td>
      <td>${f.time||'—'}</td>
      <td>${cls}</td>
      <td>
        <div class="row">
          <button class="ghost" data-id="${f.id}">Bearbeiten</button>
          <button class="danger" data-del="${f.id}">Löschen</button>
        </div>
      </td>
    `;
    tr.querySelector('[data-id]').addEventListener('click', async ()=>{
      const snapOne = await get(child(ref(db),`flights/${f.id}`));
      const fresh = snapOne.val()||{};
      editingId = f.id; editBadge.style.display='inline-block';
      fNumber.value = fresh.number||''; fOrigin.value=fresh.origin||''; fDestination.value=fresh.destination||'';
      fDate.value=fresh.date||''; fTime.value=fresh.time||''; fDuration.value=fresh.durationMin||'';
      renderClassesUI({id:f.id,...fresh});
      window.scrollTo({top:0,behavior:'smooth'});
    });
    tr.querySelector('[data-del]').addEventListener('click', async ()=>{
      if(!confirm('Flug löschen?')) return;
      try{ await remove(ref(db,`flights/${f.id}`)); if(editingId===f.id) clearForm(); }
      catch(e){ console.error(e); alert('Löschen fehlgeschlagen.'); }
    });
    rows.appendChild(tr);
  }
});
</script>
</body>
</html>
