<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerogem Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-50 text-gray-800;
        }
        .container {
            @apply max-w-6xl mx-auto p-4;
        }
        .card {
            @apply bg-white p-6 rounded-2xl shadow-lg;
        }
        .btn-primary {
            @apply px-6 py-3 bg-blue-600 text-white font-medium rounded-xl hover:bg-blue-700 transition duration-300;
        }
        .btn-danger {
            @apply px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-xl hover:bg-red-600 transition duration-300;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-xl hover:bg-gray-300 transition duration-300;
        }
        .input {
            @apply mt-1 block w-full rounded-xl border-gray-300 shadow-sm;
        }
        .section-heading {
            @apply text-2xl font-bold text-blue-900 mb-6 border-b pb-2;
        }
    </style>
</head>
<body>
    <div class="container my-12 space-y-12">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-blue-900">Aerogem Admin Panel</h1>
            <p class="text-xs text-gray-500 mt-2">Willkommen, Administrator. Hier können Sie Flüge und Buchungen verwalten. Ihre Benutzer-ID lautet: <span id="userIdDisplay">Wird geladen...</span></p>
        </div>

        <!-- Add Flight Section -->
        <div class="card space-y-6">
            <h2 class="section-heading">Flug hinzufügen</h2>
            <form id="add-flight-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="flugnr" class="block text-sm font-medium text-gray-700">Flugnummer</label>
                        <input type="text" id="flugnr" required class="input">
                    </div>
                    <div>
                        <label for="klasse" class="block text-sm font-medium text-gray-700">Klasse</label>
                        <select id="klasse" required class="input">
                            <option value="Economy">Economy</option>
                            <option value="Business">Business</option>
                            <option value="First Class">First Class</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="abflugort" class="block text-sm font-medium text-gray-700">Abflughafen</label>
                        <input type="text" id="abflugort" placeholder="z.B. FRA" required class="input">
                    </div>
                    <div>
                        <label for="ankunftsort" class="block text-sm font-medium text-gray-700">Ankunftsflughafen</label>
                        <input type="text" id="ankunftsort" placeholder="z.B. LAX" required class="input">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="datum" class="block text-sm font-medium text-gray-700">Datum</label>
                        <input type="date" id="datum" required class="input">
                    </div>
                    <div>
                        <label for="zeit" class="block text-sm font-medium text-gray-700">Zeit</label>
                        <input type="time" id="zeit" required class="input">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="dauerMin" class="block text-sm font-medium text-gray-700">Dauer (Minuten)</label>
                        <input type="number" id="dauerMin" required class="input">
                    </div>
                    <div>
                        <label for="preis" class="block text-sm font-medium text-gray-700">Preis (€)</label>
                        <input type="number" id="preis" required class="input">
                    </div>
                </div>
                <button type="submit" class="btn-primary w-full">Flug speichern</button>
            </form>
        </div>

        <!-- Flights and Bookings Section -->
        <div class="card space-y-6">
            <h2 class="section-heading">Aktuelle Flüge & Buchungen</h2>
            <div id="active-flights-list" class="space-y-4">
                <p class="text-center text-gray-500">Lade Flüge...</p>
            </div>

            <div id="booking-list" class="space-y-4">
                <p class="text-center text-gray-500">Lade Buchungen...</p>
            </div>
        </div>
        
        <!-- Archive and Search Section -->
        <div class="card space-y-6">
            <h2 class="section-heading">Archivierte Flüge & Buchungen</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <input type="text" id="archive-search-input" placeholder="Nach Flug, Kunde oder ID suchen..." class="input flex-grow">
                <button id="archive-search-btn" class="btn-secondary w-full md:w-auto">Suchen</button>
            </div>
            
            <div id="archived-data-list" class="space-y-4">
                <p class="text-center text-gray-500">Suchen Sie nach archivierten Daten.</p>
            </div>
            
            <button id="clear-archive-btn" class="btn-danger w-full md:w-auto mt-4">Archivierte Daten löschen</button>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white text-center rounded-xl shadow-lg transition-all duration-300 hidden" style="max-width: 300px;">
            <p id="messageText"></p>
        </div>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, child, remove, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAjC4kzGs2G2gT9kiNSa5YzBRNy3IiqkTo",
            authDomain: "luciennervt.firebaseapp.com",
            databaseURL: "https://luciennervt-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "luciennervt",
            storageBucket: "luciennervt.firebasestorage.app",
            messagingSenderId: "483314146697",
            appId: "1:483314146697:web:46b08edad2180cbce05558"
        };
        
        // IMPORTANT: Use the global variables provided by the Canvas environment for paths and auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const sanitizedAppId = appId.replace(/\./g, '-');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const userIdDisplay = document.getElementById('userIdDisplay');
        const activeFlightsList = document.getElementById('active-flights-list');
        const bookingList = document.getElementById('booking-list');
        const archivedDataList = document.getElementById('archived-data-list');

        const airportCodes = {
            'DUS': 'Düsseldorf', 'FRA': 'Frankfurt', 'BER': 'Berlin', 'MUC': 'München',
            'AMS': 'Amsterdam', 'LAX': 'Los Angeles', 'JFK': 'New York', 'CDG': 'Paris',
            'LHR': 'London', 'ZRH': 'Zürich', 'VIE': 'Wien', 'MAD': 'Madrid',
            'FCO': 'Rom', 'DXB': 'Dubai', 'SYD': 'Sydney', 'NRT': 'Tokio',
            'SFO': 'San Francisco', 'BCN': 'Barcelona', 'IST': 'Istanbul', 'BKK': 'Bangkok',
            'ORD': 'Chicago', 'TXL': 'Berlin', 'CGN': 'Köln/Bonn'
        };

        let flightsRef, bookingsRef, archivedFlightsRef, archivedBookingsRef;
        let allFlights = [];
        let allBookings = [];
        let archivedFlights = [];
        let archivedBookings = [];
        let authReady = false;

        // Message box functions
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // Authenticate user and get references
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                userIdDisplay.textContent = userId;
                
                flightsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/flights`);
                bookingsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/bookings`);
                archivedFlightsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/archived_flights`);
                archivedBookingsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/archived_bookings`);
                authReady = true;
                
                listenForFlights();
                listenForBookings();
                listenForArchivedData();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Authentifizierungsfehler:", e);
                    showMessage("Fehler bei der Authentifizierung.");
                }
            }
        });

        // Listen for active flights
        function listenForFlights() {
            onValue(flightsRef, (snapshot) => {
                const flightsData = snapshot.val();
                allFlights = flightsData ? Object.keys(flightsData).map(key => ({ id: key, ...flightsData[key] })) : [];
                renderActiveFlights();
            });
        }
        
        // Listen for bookings
        function listenForBookings() {
            onValue(bookingsRef, (snapshot) => {
                const bookingsData = snapshot.val();
                allBookings = bookingsData ? Object.keys(bookingsData).map(key => ({ id: key, ...bookingsData[key] })) : [];
                renderBookings();
            });
        }
        
        // Listen for archived data
        function listenForArchivedData() {
            onValue(archivedFlightsRef, (snapshot) => {
                const data = snapshot.val();
                archivedFlights = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                // Re-render archived data to show search results if a search is active
                const searchTerm = document.getElementById('archive-search-input').value;
                if(searchTerm) renderArchivedData(searchTerm);
            });
            onValue(archivedBookingsRef, (snapshot) => {
                const data = snapshot.val();
                archivedBookings = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                // Re-render archived data to show search results if a search is active
                const searchTerm = document.getElementById('archive-search-input').value;
                if(searchTerm) renderArchivedData(searchTerm);
            });
        }
        
        // Render active flights
        function renderActiveFlights() {
            activeFlightsList.innerHTML = '';
            if (allFlights.length > 0) {
                allFlights.forEach(flight => {
                    const flightItem = createFlightItem(flight);
                    activeFlightsList.appendChild(flightItem);
                });
            } else {
                activeFlightsList.innerHTML = '<p class="text-center text-gray-500">Keine aktiven Flüge gefunden.</p>';
            }
        }
        
        // Render bookings
        function renderBookings() {
            bookingList.innerHTML = '';
            if (allBookings.length > 0) {
                allBookings.forEach(booking => {
                    const bookingItem = createBookingItem(booking);
                    bookingList.appendChild(bookingItem);
                });
            } else {
                bookingList.innerHTML = '<p class="text-center text-gray-500">Keine Buchungen gefunden.</p>';
            }
        }
        
        // Render archived data with optional search filter
        function renderArchivedData(searchTerm = '') {
            archivedDataList.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredFlights = archivedFlights.filter(f => 
                Object.values(f).some(val => 
                    String(val).toLowerCase().includes(lowerCaseSearchTerm)
                )
            );
            const filteredBookings = archivedBookings.filter(b => 
                Object.values(b).some(val => 
                    String(val).toLowerCase().includes(lowerCaseSearchTerm)
                ) || 
                (b.itinerary && JSON.stringify(b.itinerary).toLowerCase().includes(lowerCaseSearchTerm))
            );

            if (filteredFlights.length > 0) {
                archivedDataList.innerHTML += '<h4 class="text-lg font-semibold text-blue-700 mt-6 mb-2">Archivierte Flüge</h4>';
                filteredFlights.forEach(flight => {
                    archivedDataList.appendChild(createFlightItem(flight, true));
                });
            }
            if (filteredBookings.length > 0) {
                archivedDataList.innerHTML += '<h4 class="text-lg font-semibold text-blue-700 mt-6 mb-2">Archivierte Buchungen</h4>';
                filteredBookings.forEach(booking => {
                    archivedDataList.appendChild(createBookingItem(booking, true));
                });
            }
            if (filteredFlights.length === 0 && filteredBookings.length === 0) {
                archivedDataList.innerHTML = '<p class="text-center text-gray-500">Keine archivierten Daten gefunden.</p>';
            }
        }

        // Create HTML for a flight item
        function createFlightItem(flight, isArchived = false) {
            const flightItem = document.createElement('div');
            flightItem.className = 'card flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';
            const departureCity = airportCodes[flight.abflug] || flight.abflug;
            const arrivalCity = airportCodes[flight.ankunft] || flight.ankunft;
            
            flightItem.innerHTML = `
                <div class="flex-grow space-y-1">
                    <p class="text-lg font-bold text-blue-900">${departureCity} (${flight.abflug}) &rarr; ${arrivalCity} (${flight.ankunft})</p>
                    <p class="text-sm text-gray-600">Flugnr: ${flight.flugnr} • Datum: ${flight.datum} • Zeit: ${flight.zeit}</p>
                    <p class="text-sm font-medium text-gray-600">Klasse: ${flight.klasse} • Dauer: ${flight.dauerMin} Min • Preis: ${flight.preis} €</p>
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2">
                    ${isArchived ? `
                        <button class="btn-danger permanent-delete-flight-btn" data-id="${flight.id}" title="Archivierten Flug dauerhaft löschen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    ` : `
                        <button class="btn-secondary archive-flight-btn" data-id="${flight.id}" title="Flug archivieren">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 4-4v5z" /></svg>
                        </button>
                    `}
                </div>
            `;
            return flightItem;
        }

        // Create HTML for a booking item
        function createBookingItem(booking, isArchived = false) {
            const bookingItem = document.createElement('div');
            bookingItem.className = 'card flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';
            
            const itineraryHtml = booking.itinerary.map((flight, index) => {
                 const departureCity = airportCodes[flight.abflug] || flight.abflug;
                 const arrivalCity = airportCodes[flight.ankunft] || flight.ankunft;
                 return `<p class="text-xs text-gray-600">
                     Flug ${index + 1}: ${departureCity} (${flight.abflug}) &rarr; ${arrivalCity} (${flight.ankunft}) | Datum: ${flight.datum} | Zeit: ${flight.zeit}
                 </p>`;
            }).join('');
            
            bookingItem.innerHTML = `
                <div class="flex-grow space-y-1">
                    <p class="text-lg font-bold text-blue-900">${booking.name}</p>
                    <p class="text-sm text-gray-600">Email: ${booking.email} • Tel: ${booking.telefon} • Geburtsdatum: ${booking.dob}</p>
                    <p class="text-sm text-gray-600">Gesamtpreis: ${booking.totalPrice.toFixed(2)} €</p>
                    ${itineraryHtml}
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2">
                    ${isArchived ? `
                        <button class="btn-danger permanent-delete-booking-btn" data-id="${booking.id}" title="Archivierte Buchung dauerhaft löschen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    ` : `
                        <button class="btn-secondary archive-booking-btn" data-id="${booking.id}" title="Buchung archivieren">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 4-4v5z" /></svg>
                        </button>
                    `}
                </div>
            `;
            return bookingItem;
        }

        // Event listener for adding a new flight
        const addFlightForm = document.getElementById('add-flight-form');
        addFlightForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!authReady) { showMessage("Seite lädt noch. Bitte warten."); return; }
            const newFlight = {
                flugnr: document.getElementById('flugnr').value,
                klasse: document.getElementById('klasse').value,
                abflug: document.getElementById('abflugort').value.toUpperCase(),
                ankunft: document.getElementById('ankunftsort').value.toUpperCase(),
                datum: document.getElementById('datum').value,
                zeit: document.getElementById('zeit').value,
                dauerMin: parseInt(document.getElementById('dauerMin').value, 10),
                preis: parseFloat(document.getElementById('preis').value)
            };
            try {
                await push(flightsRef, newFlight);
                addFlightForm.reset();
                showMessage("Flug erfolgreich hinzugefügt!");
            } catch (e) {
                console.error("Fehler beim Hinzufügen des Fluges:", e);
                showMessage("Fehler beim Hinzufügen des Fluges.");
            }
        });

        // Event listeners for archiving and deleting
        document.addEventListener('click', async (e) => {
            if (!authReady) { showMessage("Seite lädt noch. Bitte warten."); return; }
            
            // Archive flight
            if (e.target.closest('.archive-flight-btn')) {
                const button = e.target.closest('.archive-flight-btn');
                const flightId = button.getAttribute('data-id');
                const flightToArchive = allFlights.find(f => f.id === flightId);
                if (flightToArchive) {
                    try {
                        await push(archivedFlightsRef, flightToArchive);
                        await remove(child(flightsRef, flightId));
                        showMessage("Flug wurde archiviert.");
                    } catch (e) {
                        console.error("Fehler beim Archivieren des Fluges:", e);
                        showMessage("Fehler beim Archivieren des Fluges.");
                    }
                }
            }

            // Archive booking
            if (e.target.closest('.archive-booking-btn')) {
                const button = e.target.closest('.archive-booking-btn');
                const bookingId = button.getAttribute('data-id');
                const bookingToArchive = allBookings.find(b => b.id === bookingId);
                if (bookingToArchive) {
                    try {
                        await push(archivedBookingsRef, bookingToArchive);
                        await remove(child(bookingsRef, bookingId));
                        showMessage("Buchung wurde archiviert.");
                    } catch (e) {
                        console.error("Fehler beim Archivieren der Buchung:", e);
                        showMessage("Fehler beim Archivieren der Buchung.");
                    }
                }
            }
            
            // Permanent delete archived flight
            if (e.target.closest('.permanent-delete-flight-btn')) {
                const button = e.target.closest('.permanent-delete-flight-btn');
                const flightId = button.getAttribute('data-id');
                try {
                    await remove(child(archivedFlightsRef, flightId));
                    showMessage("Archivierter Flug wurde dauerhaft gelöscht.");
                } catch (e) {
                    console.error("Fehler beim dauerhaften Löschen des Fluges:", e);
                    showMessage("Fehler beim dauerhaften Löschen des Fluges.");
                }
            }
            
            // Permanent delete archived booking
            if (e.target.closest('.permanent-delete-booking-btn')) {
                const button = e.target.closest('.permanent-delete-booking-btn');
                const bookingId = button.getAttribute('data-id');
                try {
                    await remove(child(archivedBookingsRef, bookingId));
                    showMessage("Archivierte Buchung wurde dauerhaft gelöscht.");
                } catch (e) {
                    console.error("Fehler beim dauerhaften Löschen der Buchung:", e);
                    showMessage("Fehler beim dauerhaften Löschen der Buchung.");
                }
            }
        });
        
        // Search archived data
        document.getElementById('archive-search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('archive-search-input').value;
            renderArchivedData(searchTerm);
        });
        
        // Clear archived data
        document.getElementById('clear-archive-btn').addEventListener('click', async () => {
            if (!authReady) return;
            try {
                // Get all archived data and then delete
                const flightsSnapshot = await get(archivedFlightsRef);
                const bookingsSnapshot = await get(archivedBookingsRef);
                
                if (flightsSnapshot.exists()) await remove(archivedFlightsRef);
                if (bookingsSnapshot.exists()) await remove(archivedBookingsRef);
                
                showMessage("Archivierte Daten erfolgreich gelöscht.");
                archivedDataList.innerHTML = '<p class="text-center text-gray-500">Archivierte Daten erfolgreich gelöscht.</p>';
            } catch (e) {
                console.error("Fehler beim Löschen des Archivs:", e);
                showMessage("Fehler beim Löschen des Archivs.");
            }
        });
        
        // Message box
        window.showMessage = showMessage;
    </script>
</body>
</html>
