<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aerogem – Admin</title>
<style>
    :root{--bg:#f6f7f9;--card:#fff;--fg:#0a0a0a;--muted:#64748b;--accent:#007aff;--border:#e5e7eb;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{padding:18px 16px;text-align:center;background:#fff;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:22px;font-weight:700}
    .note{background:#ffe8e8;color:#7a1d1d;text-align:center;padding:10px;font-weight:600;border-bottom:1px solid #ffd4d4}
    .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;gap:12px}
    @media(min-width:960px){.grid.cols-6{grid-template-columns:repeat(6,1fr)}}
    label{font-size:13px;color:#444;display:block;margin:0 0 6px}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:15px}
    input:focus,button:focus{outline:2px solid rgba(0,122,255,.25);outline-offset:1px}
    button{background:var(--accent);color:#fff;border:none;font-weight:600;cursor:pointer}
    button.ghost{background:#f3f4f6;color:#111;border:1px solid var(--border)}
    button.danger{background:var(--danger);color:#fff;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{color:#475569;font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fafafa}
    .clsHeader{display:grid;grid-template-columns:2fr 1fr auto;gap:8px;font-size:12px;color:#475569;margin-top:6px}
    .clsGrid{display:grid;grid-template-columns:2fr 1fr auto;gap:8px}
    .muted{color:#64748b}
    .msg{padding:10px;border-radius:8px;font-size:14px;margin-top:6px;text-align:center}
    .ok{background:#ecfdf3;color:#166534;border:1px solid #bbf7d0}
    .err{background:#fef2f2;color:#7f1d1d;border:1px solid #fecaca}
</style>
</head>
<body>
    <div class="note">Demo-Website. Es werden keine echten Flüge verkauft.</div>
    <header><h1>Aerogem – Admin</h1></header>

    <div class="wrap">
        <div class="card">
            <h2 style="margin:0 0 10px 0;font-size:18px">Flug verwalten</h2>
            <div class="grid cols-6">
                <div><label for="fNumber">Flugnummer</label><input id="fNumber" placeholder="AG123" required></div>
                <div><label for="fOrigin">Abflug (IATA)</label><input id="fOrigin" placeholder="DUS" required></div>
                <div><label for="fDestination">Ankunft (IATA)</label><input id="fDestination" placeholder="BER" required></div>
                <div><label for="fDate">Datum</label><input id="fDate" type="date" required></div>
                <div><label for="fTime">Uhrzeit</label><input id="fTime" type="time" required></div>
                <div><label for="fDuration">Dauer (Min, optional)</label><input id="fDuration" type="number" min="0"></div>
            </div>

            <h3 style="margin:16px 0 6px 0;font-size:16px">Klassen</h3>
            <div class="clsHeader"><div>Name</div><div>Preis (€)</div><div></div></div>
            <div id="classesContainer" class="clsGrid" style="margin-bottom:8px"></div>
            <div class="row">
                <button id="addClass" class="ghost" type="button">Weitere Klasse</button>
            </div>
            
            <div id="msg" class="msg" style="display:none"></div>

            <div class="row" style="margin-top:12px">
                <button id="saveBtn" type="button">Speichern</button>
                <button id="resetBtn" class="ghost" type="button">Felder leeren</button>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2 style="margin:0 0 10px 0;font-size:18px">Flüge</h2>
            <table>
                <thead><tr><th>Flug</th><th>Route</th><th>Datum</th><th>Uhrzeit</th><th>Klassen</th><th>Aktionen</th></tr></thead>
                <tbody id="flightRows"></tbody>
            </table>
            <div class="muted" id="emptyHint" style="margin-top:8px;display:none">Noch keine Flüge vorhanden.</div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// UI references
const fNumber = document.getElementById('fNumber');
const fOrigin = document.getElementById('fOrigin');
const fDestination = document.getElementById('fDestination');
const fDate = document.getElementById('fDate');
const fTime = document.getElementById('fTime');
const fDuration = document.getElementById('fDuration');
const classesContainer = document.getElementById('classesContainer');
const addClassBtn = document.getElementById('addClass');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const flightRows = document.getElementById('flightRows');
const emptyHint = document.getElementById('emptyHint');
const msgBox = document.getElementById('msg');

let editingId = null;

function showMsg(text, isSuccess) {
    msgBox.textContent = text;
    msgBox.className = 'msg ' + (isSuccess ? 'ok' : 'err');
    msgBox.style.display = 'block';
    setTimeout(() => { msgBox.style.display = 'none'; }, 5000);
}

function toKey(name) {
    return name.toLowerCase().trim().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').slice(0, 24);
}

function classRow(name = "", price = "") {
    const wrap = document.createElement('div');
    wrap.style.display = "contents";
    wrap.innerHTML = `
        <input class="clsName" placeholder="z. B. Economy" value="${name}" required>
        <input class="clsPrice" type="number" step="0.01" min="0" placeholder="0.00" value="${price}" required>
        <button class="danger" type="button">Entfernen</button>
    `;
    wrap.querySelector('.danger').addEventListener('click', () => { wrap.remove(); });
    return wrap;
}

function clearForm() {
    editingId = null;
    [fNumber, fOrigin, fDestination, fDate, fTime, fDuration].forEach(i => i.value = "");
    classesContainer.innerHTML = "";
    ensureDefaults();
    showMsg('Formular geleert.', true);
}

function ensureDefaults() {
    if (classesContainer.children.length === 0) {
        classesContainer.appendChild(classRow("Economy", "49"));
        classesContainer.appendChild(classRow("Business", "129"));
        classesContainer.appendChild(classRow("First", "199"));
    }
}

function collectClasses() {
    const rows = classesContainer.querySelectorAll('.clsName');
    const res = {};
    for (const nameInput of rows) {
        const row = nameInput.parentElement;
        const priceInput = row.querySelector('.clsPrice');
        const name = nameInput.value.trim();
        const price = parseFloat(priceInput.value);
        if (!name) continue;
        if (!isFinite(price) || price < 0) continue;
        const key = toKey(name);
        res[key] = { name, price: Number(price) };
    }
    return res;
}

async function saveFlight() {
    const flight = {
        number: (fNumber.value || "").trim(),
        origin: (fOrigin.value || "").trim().toUpperCase(),
        destination: (fDestination.value || "").trim().toUpperCase(),
        date: (fDate.value || "").trim(),
        time: (fTime.value || "").trim(),
        durationMin: fDuration.value ? Number(fDuration.value) : null
    };

    if (!flight.origin || !flight.destination || !flight.date || !flight.time) {
        return showMsg("Route, Datum, Uhrzeit sind Pflichtfelder.", false);
    }
    const classes = collectClasses();
    if (Object.keys(classes).length === 0) {
        return showMsg("Mindestens eine Klasse mit Preis angeben.", false);
    }

    try {
        if (editingId) {
            await set(ref(db, `flights/${editingId}`), { ...flight, classes });
            showMsg("Flug erfolgreich aktualisiert!", true);
        } else {
            const newRef = push(ref(db, 'flights'));
            await set(newRef, { ...flight, classes });
            showMsg("Flug erfolgreich hinzugefügt!", true);
        }
        clearForm();
    } catch (e) {
        console.error("Speichern fehlgeschlagen:", e);
        showMsg("Speichern fehlgeschlagen.", false);
    }
}

function renderFlights(data) {
    const list = Object.entries(data).map(([id, f]) => ({ id, ...f }));
    list.sort((a, b) => (`${a.date || ''} ${a.time || ''}`).localeCompare(`${b.date || ''} ${b.time || ''}`));
    flightRows.innerHTML = '';
    emptyHint.style.display = list.length ? 'none' : 'block';

    for (const f of list) {
        const tr = document.createElement('tr');
        const classesStr = f.classes ? Object.values(f.classes).map(c => `${c.name} (${Number(c.price || 0).toFixed(2)} €)`).join(', ') : '—';
        tr.innerHTML = `
            <td>${f.number || '—'}</td>
            <td>${f.origin || '?'} → ${f.destination || '?'}</td>
            <td>${f.date || '—'}</td>
            <td>${f.time || '—'}</td>
            <td>${classesStr}</td>
            <td>
                <div class="row">
                    <button class="ghost" data-edit="${f.id}" type="button">Bearbeiten</button>
                    <button class="danger" data-del="${f.id}" type="button">Löschen</button>
                </div>
            </td>
        `;
        tr.querySelector('[data-edit]').addEventListener('click', () => editFlight(f.id));
        tr.querySelector('[data-del]').addEventListener('click', () => deleteFlight(f.id));
        flightRows.appendChild(tr);
    }
}

async function editFlight(id) {
    const flight = await get(ref(db, `flights/${id}`)).then(snap => snap.val());
    if (!flight) return showMsg("Flug nicht gefunden.", false);

    editingId = id;
    fNumber.value = flight.number || '';
    fOrigin.value = flight.origin || '';
    fDestination.value = flight.destination || '';
    fDate.value = flight.date || '';
    fTime.value = flight.time || '';
    fDuration.value = flight.durationMin || '';

    classesContainer.innerHTML = '';
    const cls = flight.classes || {};
    if (Object.keys(cls).length) {
        for (const k in cls) {
            classesContainer.appendChild(classRow(cls[k].name, Number(cls[k].price)));
        }
    } else {
        ensureDefaults();
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteFlight(id) {
    if (!confirm('Diesen Flug wirklich löschen?')) return;
    try {
        await remove(ref(db, `flights/${id}`));
        if (editingId === id) clearForm();
        showMsg("Flug erfolgreich gelöscht.", true);
    } catch (e) {
        console.error("Löschen fehlgeschlagen:", e);
        showMsg("Löschen fehlgeschlagen.", false);
    }
}

// Event Listeners
addClassBtn.addEventListener('click', () => classesContainer.appendChild(classRow()));
saveBtn.addEventListener('click', saveFlight);
resetBtn.addEventListener('click', clearForm);

// Initial load
onValue(ref(db, 'flights'), snap => {
    const data = snap.val() || {};
    renderFlights(data);
});

// Initial Form state
clearForm();
</script>
</body>
</html>
