<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerogem Admin-Ansicht</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .container {
            @apply max-w-5xl mx-auto p-4 md:p-8;
        }
        .card {
            @apply bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-200;
        }
        .btn {
            @apply px-4 py-2 font-medium rounded-xl transition duration-300;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-red {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-green {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        .input-field {
            @apply mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500;
        }
        .section-header {
            @apply text-2xl font-bold text-blue-800 mb-4;
        }
    </style>
</head>
<body>
    <div class="container space-y-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-900 mt-8 mb-4">Aerogem Admin-Dashboard</h1>
        <p class="text-center text-gray-500 text-sm">Demo-Website. Es werden keine echten Flüge verwaltet.</p>

        <!-- Status & User Info -->
        <div class="card text-center text-gray-600 font-medium">
            <p id="user-info">Authentifiziere...</p>
        </div>

        <!-- Add Flight Section -->
        <div id="add-flight-section" class="card hidden">
            <h2 class="section-header">Flug hinzufügen</h2>
            <form id="add-flight-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="flugnr" class="block text-sm font-medium text-gray-700">Flugnr.</label>
                        <input type="text" id="flugnr" required class="input-field" placeholder="z.B. LH456">
                    </div>
                    <div>
                        <label for="klasse" class="block text-sm font-medium text-gray-700">Klasse</label>
                        <input type="text" id="klasse" required class="input-field" placeholder="z.B. Economy">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="abflugort" class="block text-sm font-medium text-gray-700">Abflug (Code)</label>
                        <input type="text" id="abflugort" required class="input-field" placeholder="z.B. DUS">
                    </div>
                    <div>
                        <label for="ankunftort" class="block text-sm font-medium text-gray-700">Ankunft (Code)</label>
                        <input type="text" id="ankunftort" required class="input-field" placeholder="z.B. LAX">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="datum" class="block text-sm font-medium text-gray-700">Datum</label>
                        <input type="date" id="datum" required class="input-field">
                    </div>
                    <div>
                        <label for="zeit" class="block text-sm font-medium text-gray-700">Zeit</label>
                        <input type="time" id="zeit" required class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dauerMin" class="block text-sm font-medium text-gray-700">Dauer (Min)</label>
                        <input type="number" id="dauerMin" required class="input-field" placeholder="z.B. 120">
                    </div>
                    <div>
                        <label for="preis" class="block text-sm font-medium text-gray-700">Preis (€)</label>
                        <input type="number" step="0.01" id="preis" required class="input-field" placeholder="z.B. 99.99">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-full mt-4">Flug hinzufügen</button>
            </form>
        </div>

        <!-- Flights & Bookings Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div id="flights-section" class="card hidden">
                <h2 class="section-header">Aktuelle Flüge</h2>
                <div id="flights-list" class="space-y-4">
                    <p class="text-gray-500">Lade Flüge...</p>
                </div>
            </div>

            <div id="bookings-section" class="card hidden">
                <h2 class="section-header">Aktuelle Buchungen</h2>
                <div id="bookings-list" class="space-y-4">
                    <p class="text-gray-500">Lade Buchungen...</p>
                </div>
            </div>
        </div>

        <!-- Archived Data Section -->
        <div id="archive-section" class="card hidden">
            <h2 class="section-header">Archivierte Daten</h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                <input type="text" id="archive-search-input" placeholder="Nach Flug oder Kunde suchen..." class="input-field flex-grow">
                <select id="archive-filter-select" class="input-field flex-shrink-0">
                    <option value="all">Alle archivierten Daten</option>
                    <option value="flights">Nur Flüge</option>
                    <option value="bookings">Nur Buchungen</option>
                </select>
            </div>
            <div id="archived-data-list" class="space-y-4">
                <p class="text-gray-500">Lade Archiv...</p>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white text-center rounded-xl shadow-lg transition-all duration-300 hidden" style="max-width: 300px;">
            <p id="messageText"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, child, update, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAjC4kzGs2G2gT9kiNSa5YzBRNy3IiqkTo",
            authDomain: "luciennervt.firebaseapp.com",
            databaseURL: "https://luciennervt-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "luciennervt",
            storageBucket: "luciennervt.firebasestorage.app",
            messagingSenderId: "483314146697",
            appId: "1:483314146697:web:46b08edad2180cbce05558"
        };
        
        // IMPORTANT: Use the global variables provided by the Canvas environment for paths and auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const sanitizedAppId = appId.replace(/\./g, '-');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userId = null;
        let flightsRef = null;
        let bookingsRef = null;
        let archivedRef = null;
        let authReady = false;

        let allFlights = [];
        let allBookings = [];
        let archivedFlights = [];
        let archivedBookings = [];

        // Message box functions
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // Authenticate user
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                flightsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/flights`);
                bookingsRef = ref(db, `artifacts/${sanitizedAppId}/public/data/bookings`);
                archivedRef = ref(db, `artifacts/${sanitizedAppId}/public/data/archive`);
                authReady = true;
                
                document.getElementById('add-flight-section').classList.remove('hidden');
                document.getElementById('flights-section').classList.remove('hidden');
                document.getElementById('bookings-section').classList.remove('hidden');
                document.getElementById('archive-section').classList.remove('hidden');
                document.getElementById('user-info').textContent = `Angemeldet als: Admin (ID: ${userId})`;

                listenForFlights();
                listenForBookings();
                listenForArchivedData();

            } else {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Authentifizierungsfehler:", e);
                    showMessage("Fehler bei der Authentifizierung.");
                }
            }
        });
        
        // Listeners for data changes
        function listenForFlights() {
            onValue(flightsRef, (snapshot) => {
                const flightsData = snapshot.val();
                allFlights = flightsData ? Object.keys(flightsData).map(key => ({ id: key, ...flightsData[key] })) : [];
                renderFlights();
            });
        }
        
        function listenForBookings() {
            onValue(bookingsRef, (snapshot) => {
                const bookingsData = snapshot.val();
                allBookings = bookingsData ? Object.keys(bookingsData).map(key => ({ id: key, ...bookingsData[key] })) : [];
                renderBookings();
            });
        }

        function listenForArchivedData() {
            onValue(archivedRef, (snapshot) => {
                const archivedData = snapshot.val() || {};
                archivedFlights = Object.values(archivedData.flights || {});
                archivedBookings = Object.values(archivedData.bookings || {});
                renderArchivedData();
            });
        }
        
        // Render functions
        function renderFlights() {
            const flightsList = document.getElementById('flights-list');
            flightsList.innerHTML = '';
            if (allFlights.length === 0) {
                flightsList.innerHTML = '<p class="text-gray-500">Keine Flüge vorhanden.</p>';
            } else {
                allFlights.forEach(flight => {
                    const flightItem = document.createElement('div');
                    flightItem.className = 'bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between shadow-sm';
                    flightItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${flight.abflug} &rarr; ${flight.ankunft} (${flight.flugnr})</p>
                            <p class="text-sm text-gray-600">Datum: ${flight.datum} | Zeit: ${flight.zeit} | Preis: ${flight.preis} €</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${flight.id}" data-type="flight" class="archive-btn btn bg-gray-200 text-gray-800 hover:bg-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H4a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2H7a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button data-id="${flight.id}" data-type="flight" class="delete-btn btn bg-red-500 text-white hover:bg-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    flightsList.appendChild(flightItem);
                });
            }
        }
        
        function renderBookings() {
            const bookingsList = document.getElementById('bookings-list');
            bookingsList.innerHTML = '';
            if (allBookings.length === 0) {
                bookingsList.innerHTML = '<p class="text-gray-500">Keine Buchungen vorhanden.</p>';
            } else {
                allBookings.forEach(booking => {
                    const bookingItem = document.createElement('div');
                    bookingItem.className = 'bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between shadow-sm';
                    const itineraryHtml = booking.itinerary.map(leg => `${leg.abflug} &rarr; ${leg.ankunft}`).join(' | ');
                    bookingItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${booking.name}</p>
                            <p class="text-sm text-gray-600">Reiseroute: ${itineraryHtml}</p>
                            <p class="text-sm text-gray-600">Preis: ${booking.totalPrice} €</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${booking.id}" data-type="booking" class="archive-btn btn bg-gray-200 text-gray-800 hover:bg-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H4a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2H7a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1zm3 4a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button data-id="${booking.id}" data-type="booking" class="delete-btn btn bg-red-500 text-white hover:bg-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    bookingsList.appendChild(bookingItem);
                });
            }
        }
        
        function renderArchivedData() {
            const dataList = document.getElementById('archived-data-list');
            const filter = document.getElementById('archive-filter-select').value;
            const searchTerm = document.getElementById('archive-search-input').value.toLowerCase();
            dataList.innerHTML = '';
            
            const renderItem = (item, type) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-white p-4 rounded-lg border border-gray-200 shadow-sm';
                if (type === 'flight') {
                    itemDiv.innerHTML = `
                        <p class="font-bold text-lg text-gray-700">Flug archiviert</p>
                        <p class="text-sm text-gray-600">${item.abflug} &rarr; ${item.ankunft} (${item.flugnr})</p>
                        <p class="text-xs text-gray-500">Datum: ${item.datum} | Preis: ${item.preis} €</p>
                    `;
                } else if (type === 'booking') {
                    const itineraryHtml = item.itinerary.map(leg => `${leg.abflug} &rarr; ${leg.ankunft}`).join(' | ');
                     itemDiv.innerHTML = `
                        <p class="font-bold text-lg text-gray-700">Buchung archiviert</p>
                        <p class="text-sm text-gray-600">Kunde: ${item.name}</p>
                        <p class="text-sm text-gray-600">Reise: ${itineraryHtml}</p>
                    `;
                }
                dataList.appendChild(itemDiv);
            };

            const filteredFlights = archivedFlights.filter(f => 
                f.abflug.toLowerCase().includes(searchTerm) || 
                f.ankunft.toLowerCase().includes(searchTerm) ||
                f.flugnr.toLowerCase().includes(searchTerm)
            );

            const filteredBookings = archivedBookings.filter(b => 
                b.name.toLowerCase().includes(searchTerm) ||
                b.itinerary.some(leg => leg.abflug.toLowerCase().includes(searchTerm) || leg.ankunft.toLowerCase().includes(searchTerm))
            );

            if (filter === 'all' || filter === 'flights') {
                filteredFlights.forEach(f => renderItem(f, 'flight'));
            }
            if (filter === 'all' || filter === 'bookings') {
                filteredBookings.forEach(b => renderItem(b, 'booking'));
            }

            if (dataList.innerHTML === '') {
                dataList.innerHTML = '<p class="text-center text-gray-500">Keine archivierten Daten gefunden.</p>';
            }
        }
        
        // Form & Button Event Listeners
        const addFlightForm = document.getElementById('add-flight-form');
        addFlightForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newFlight = {
                flugnr: document.getElementById('flugnr').value,
                datum: document.getElementById('datum').value,
                zeit: document.getElementById('zeit').value,
                klasse: document.getElementById('klasse').value,
                dauerMin: parseInt(document.getElementById('dauerMin').value),
                preis: parseFloat(document.getElementById('preis').value),
                abflug: document.getElementById('abflugort').value,
                ankunft: document.getElementById('ankunftort').value
            };

            try {
                await push(flightsRef, newFlight);
                showMessage("Flug erfolgreich hinzugefügt!");
                addFlightForm.reset();
            } catch (error) {
                console.error("Fehler beim Hinzufügen des Fluges:", error);
                showMessage("Fehler beim Hinzufügen des Fluges.");
            }
        });
        
        document.addEventListener('click', async (e) => {
            if (!authReady) return;
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.getAttribute('data-id');
            const type = target.getAttribute('data-type');
            
            if (target.classList.contains('archive-btn')) {
                let dataToArchive = null;
                let originalRef = null;

                if (type === 'flight') {
                    dataToArchive = allFlights.find(f => f.id === id);
                    originalRef = child(flightsRef, id);
                } else if (type === 'booking') {
                    dataToArchive = allBookings.find(b => b.id === id);
                    originalRef = child(bookingsRef, id);
                }
                
                if (dataToArchive) {
                    try {
                        const archivePath = `artifacts/${sanitizedAppId}/public/data/archive/${type}s`;
                        await push(ref(db, archivePath), dataToArchive);
                        await remove(originalRef);
                        showMessage(`${type === 'flight' ? 'Flug' : 'Buchung'} erfolgreich archiviert.`);
                    } catch (error) {
                        console.error(`Fehler beim Archivieren der ${type}:`, error);
                        showMessage(`Fehler beim Archivieren der ${type}.`);
                    }
                }
            }
            
            if (target.classList.contains('delete-btn')) {
                let originalRef = null;
                if (type === 'flight') {
                    originalRef = child(flightsRef, id);
                } else if (type === 'booking') {
                    originalRef = child(bookingsRef, id);
                }

                if (originalRef) {
                    try {
                        await remove(originalRef);
                        showMessage(`${type === 'flight' ? 'Flug' : 'Buchung'} erfolgreich gelöscht.`);
                    } catch (error) {
                        console.error(`Fehler beim Löschen der ${type}:`, error);
                        showMessage(`Fehler beim Löschen der ${type}.`);
                    }
                }
            }
        });

        document.getElementById('archive-search-input').addEventListener('input', renderArchivedData);
        document.getElementById('archive-filter-select').addEventListener('change', renderArchivedData);
    </script>
</body>
</html>
